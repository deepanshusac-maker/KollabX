<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KollabX - Profile</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/profile.css">
    <link rel="stylesheet" href="css/sections.css">
    <link rel="stylesheet" href="css/forms.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/toast.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <nav class="navbar">
        <a href="index.html" class="navbar-brand">
            <img src="images/logo.png" alt="KollabX Logo" class="navbar-logo">
            <h1>KollabX</h1>
        </a>
        <div class="mobile-overlay"></div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Home</a></li>
            <li><a href="explore.html" class="nav-item">Explore</a></li>
            <li class="nav-item-auth-only" style="display: none;"><a href="post.html" class="nav-item">Post Idea</a>
            </li>
            <li class="nav-item-auth-only" style="display: none;"><a href="dashboard.html"
                    class="nav-item">Dashboard</a></li>
            <li class="nav-item-auth-only" style="display: none;"><a href="profile.html"
                    class="nav-item active">Profile</a></li>
            <div class="nav-indicator"></div>
        </ul>
        <div class="nav-right">
            <button type="button" class="notification-icon" aria-label="Notifications">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    aria-hidden="true">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <div class="notification-badge" aria-hidden="true" style="display: none;">0</div>
            </button>
            <a href="signin.html" class="btn-signin">Sign In</a>
            <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <main class="profile-section">
        <div class="profile-container">
            <nav class="breadcrumbs" aria-label="Breadcrumb">
                <a href="index.html">Home</a>
                <span aria-hidden="true">/</span>
                <span aria-current="page">Profile</span>
            </nav>
            <div class="profile-header">
                <div class="avatar-wrapper">
                    <div class="avatar-circle" id="avatar-preview">
                        <svg viewBox="0 0 24 24" id="default-avatar-svg">
                            <path
                                d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z" />
                        </svg>
                        <img id="avatar-image-preview" src=""
                            style="display: none; width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <label for="avatar-upload" class="avatar-edit-btn" aria-label="Edit profile picture">
                        <i data-lucide="edit-2" aria-hidden="true"></i>
                    </label>
                    <input type="file" id="avatar-upload" accept="image/*" style="display: none;">
                </div>
                <h1 class="profile-title">Your Profile</h1>
                <p>Keep your profile updated to get better project matches</p>
            </div>

            <!-- Onboarding flow (shown when ?onboarding=true) -->
            <div id="onboarding-flow" class="onboarding hidden">
                <div class="onboarding-header">
                    <span class="onboarding-badge">Getting started</span>
                    <h2>Complete your profile in under 2 minutes</h2>
                    <p>Finish these steps so project owners see your skills and story before they accept you.</p>
                </div>
                <div class="onboarding-progress">
                    <div class="onboarding-progress-fill"></div>
                </div>
                <div class="onboarding-steps">
                    <div class="onboarding-step" data-onboarding-step="1">
                        <div class="onboarding-step-index">1</div>
                        <div class="onboarding-step-body">
                            <div class="onboarding-step-title">Add skills</div>
                            <div class="onboarding-step-subtitle">What can you actually ship?</div>
                        </div>
                    </div>
                    <div class="onboarding-step" data-onboarding-step="2">
                        <div class="onboarding-step-index">2</div>
                        <div class="onboarding-step-body">
                            <div class="onboarding-step-title">Add bio</div>
                            <div class="onboarding-step-subtitle">Help captains understand how you think.</div>
                        </div>
                    </div>
                    <div class="onboarding-step" data-onboarding-step="3">
                        <div class="onboarding-step-index">3</div>
                        <div class="onboarding-step-body">
                            <div class="onboarding-step-title">Explore missions</div>
                            <div class="onboarding-step-subtitle">Apply only to missions that truly fit.</div>
                        </div>
                    </div>
                </div>
                <div class="onboarding-cta">
                    <button type="button" id="onboarding-explore-btn" class="btn-signin onboarding-explore-btn"
                        disabled>
                        Continue to Explore
                    </button>
                    <p class="onboarding-hint">Tip: Completing skills + bio makes your applications much more likely to
                        be accepted.</p>
                </div>
            </div>

            <form class="profile-card">
                <!-- Basic Information -->
                <div class="form-section">
                    <h3>Basic Information</h3>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label for="full-name">Full Name</label>
                            <input type="text" id="full-name" class="form-control" placeholder="Deepanshu Sharma"
                                required>
                        </div>
                        <div class="form-group">
                            <label for="college">College</label>
                            <input type="text" id="college" class="form-control" placeholder="IIT Patna / NIT Rourkela"
                                required>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="bio">Short Bio</label>
                        <textarea id="bio" class="form-control"
                            placeholder="Robotics enthusiast | Love building AI projects..." required
                            maxlength="500"></textarea>
                        <div class="char-counter">
                            <span id="bio-char-count">0</span>/500 characters
                        </div>
                    </div>
                </div>

                <!-- Skills -->
                <div class="form-section">
                    <h3>Skills (for matching)</h3>
                    <div class="form-group">
                        <input type="text" id="skills" class="form-control"
                            placeholder="React, Python, Arduino, ML (comma separated)" required>
                    </div>
                </div>

                <!-- Interests -->
                <div class="form-section">
                    <h3>Interests</h3>
                    <div class="form-group">
                        <input type="text" id="interests" class="form-control"
                            placeholder="Hackathons, Startups, Robotics, Research" required>
                    </div>
                </div>

                <!-- Links -->
                <div class="form-section">
                    <h3>Links</h3>
                    <div class="form-group-row">
                        <div class="form-group">
                            <label for="github">GitHub</label>
                            <input type="url" id="github" class="form-control" placeholder="https://github.com/username"
                                >
                        </div>
                        <div class="form-group">
                            <label for="linkedin">LinkedIn</label>
                            <input type="url" id="linkedin" class="form-control"
                                placeholder="https://linkedin.com/in/username" >
                        </div>
                    </div>
                </div>

                <!-- Availability -->
                <div class="form-section">
                    <h3>Availability</h3>
                    <div class="form-group">
                        <select id="availability" class="form-control" required>
                            <option value="" disabled selected>Select availability</option>
                            <option value="immediate">Weekends only</option>
                            <option value="part-time">2-3 hrs/day</option>
                            <option value="flexible">Daily active</option>
                            <option value="flexible">Full-time project</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 3rem; display: flex; justify-content: flex-end;">
                    <button type="submit" id="save-profile" class="btn-signin"
                        style="padding: 1rem 3rem; font-size: 1rem; cursor: pointer;">Save Profile</button>
                </div>
            </form>
        </div>
    </main>



    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/session.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/main.js"></script>
    <script src="js/form-validation.js"></script>
    <script src="js/toast.js"></script>
    <script>
        // Initialize auth and protect route
        window.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const isAuth = await window.session.requireAuth();
            if (isAuth) {
                await window.session.initAuth();

                // Check if profile is already complete - if so, redirect to landing page
                const profileComplete = await window.auth.isProfileComplete();
                if (profileComplete) {
                    // Profile is complete, but user might be editing - don't auto-redirect
                    // Only redirect if they came from a new signup flow
                    const isNewUser = sessionStorage.getItem('is_new_user');
                    if (isNewUser) {
                        sessionStorage.removeItem('is_new_user');
                        // Don't redirect - let them edit if they want
                    }
                }
            }
            // Initialize Lucide Icons
            lucide.createIcons();
        });

        let profileImageData = '';
        let avatarFile = null;
        const onboardingMode = new URLSearchParams(window.location.search).get('onboarding') === 'true';

        // Compress image before upload
        function compressImage(file, maxWidth = 800, maxHeight = 800, quality = 0.8) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width;
                        let height = img.height;

                        // Calculate new dimensions
                        if (width > height) {
                            if (width > maxWidth) {
                                height = (height * maxWidth) / width;
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = (width * maxHeight) / height;
                                height = maxHeight;
                            }
                        }

                        canvas.width = width;
                        canvas.height = height;

                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);

                        canvas.toBlob(
                            (blob) => {
                                resolve(blob);
                            },
                            'image/jpeg',
                            quality
                        );
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Upload avatar to Supabase Storage
        async function uploadAvatarToStorage(file, userId) {
            try {
                const supabase = window.supabase;
                if (!supabase) {
                    throw new Error('Supabase not initialized');
                }

                // Compress image
                const compressedFile = await compressImage(file);

                // Get file extension
                const fileExt = file.name.split('.').pop();
                const fileName = `${userId}/avatar.${fileExt}`;

                // Upload to Storage
                const { data, error } = await supabase.storage
                    .from('avatars')
                    .upload(fileName, compressedFile, {
                        upsert: true, // Replace existing file
                        contentType: `image/${fileExt === 'jpg' ? 'jpeg' : fileExt}`
                    });

                if (error) throw error;

                // Get public URL
                const { data: urlData } = supabase.storage
                    .from('avatars')
                    .getPublicUrl(fileName);

                return urlData.publicUrl;
            } catch (error) {
                console.error('Error uploading avatar:', error);
                throw error;
            }
        }

        // Handle Avatar Upload
        const avatarUpload = document.getElementById('avatar-upload');
        const avatarPreview = document.getElementById('avatar-image-preview');
        const defaultAvatarSvg = document.getElementById('default-avatar-svg');

        function updateOnboardingProgress() {
            if (!onboardingMode) return;
            const container = document.getElementById('onboarding-flow');
            if (!container) return;
            container.classList.remove('hidden');

            const skillsVal = (document.getElementById('skills').value || '').trim();
            const bioVal = (document.getElementById('bio').value || '').trim();
            const hasSkills = skillsVal.length > 0;
            const hasBio = bioVal.length >= 10;
            const steps = Array.from(container.querySelectorAll('.onboarding-step'));

            let currentStep = 1;
            if (hasSkills && !hasBio) currentStep = 2;
            if (hasSkills && hasBio) currentStep = 3;

            steps.forEach(step => {
                const idx = parseInt(step.getAttribute('data-onboarding-step'), 10);
                step.classList.remove('completed', 'current');
                if (idx < currentStep) {
                    step.classList.add('completed');
                } else if (idx === currentStep) {
                    step.classList.add('current');
                }
            });

            const completedCount = (hasSkills ? 1 : 0) + (hasBio ? 1 : 0) + (hasSkills && hasBio ? 1 : 0);
            const progressEl = container.querySelector('.onboarding-progress-fill');
            if (progressEl) {
                const pct = Math.max(10, Math.min(100, (completedCount / 3) * 100));
                progressEl.style.width = pct + '%';
            }

            const exploreBtn = document.getElementById('onboarding-explore-btn');
            if (exploreBtn) {
                exploreBtn.disabled = !(hasSkills && hasBio);
            }
        }

        // Load existing profile from database
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const profile = await window.authHelpers.getCurrentProfile();
                if (profile) {
                    // Populate fields from database
                    if (profile.full_name) document.getElementById('full-name').value = profile.full_name;
                    if (profile.college) document.getElementById('college').value = profile.college;
                    if (profile.bio) document.getElementById('bio').value = profile.bio;
                    if (profile.skills && Array.isArray(profile.skills)) {
                        document.getElementById('skills').value = profile.skills.join(', ');
                    }
                    if (profile.interests && Array.isArray(profile.interests)) {
                        document.getElementById('interests').value = profile.interests.join(', ');
                    }
                    if (profile.github_url) document.getElementById('github').value = profile.github_url;
                    if (profile.linkedin_url) document.getElementById('linkedin').value = profile.linkedin_url;
                    if (profile.availability) document.getElementById('availability').value = profile.availability;

                    if (profile.avatar_url) {
                        profileImageData = profile.avatar_url;
                        avatarPreview.src = profileImageData;
                        avatarPreview.style.display = 'block';
                        defaultAvatarSvg.style.display = 'none';
                    }
                }

                if (onboardingMode) {
                    updateOnboardingProgress();
                    const exploreBtn = document.getElementById('onboarding-explore-btn');
                    if (exploreBtn) {
                        exploreBtn.addEventListener('click', () => {
                            window.location.href = 'explore.html';
                        });
                    }
                }
            } catch (error) {
                console.error('Error loading profile:', error);
            }
        });

        avatarUpload.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                showFormError('Please select an image file.');
                return;
            }

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                showFormError('Image size must be less than 5MB.');
                return;
            }

            // Show preview immediately
            const reader = new FileReader();
            reader.onload = (event) => {
                avatarPreview.src = event.target.result;
                avatarPreview.style.display = 'block';
                defaultAvatarSvg.style.display = 'none';
            };
            reader.readAsDataURL(file);

            // Store file for upload
            avatarFile = file;
            profileImageData = ''; // Clear old base64 data
        });

        const profileForm = document.querySelector('.profile-card');
        const saveButton = document.getElementById('save-profile');

        // Setup real-time validation
        setupRealTimeValidation(profileForm, {
            'github': [validators.url],
            'linkedin': [validators.url],
            'bio': [validators.minLength(10)]
        });

        // Character counter for bio
        const bioField = document.getElementById('bio');
        const bioCharCount = document.getElementById('bio-char-count');
        if (bioField && bioCharCount) {
            bioField.addEventListener('input', () => {
                bioCharCount.textContent = bioField.value.length;
                updateOnboardingProgress();
            });
            // Initialize count
            bioCharCount.textContent = bioField.value.length;
        }

        const skillsField = document.getElementById('skills');
        if (skillsField) {
            skillsField.addEventListener('input', () => {
                updateOnboardingProgress();
            });
        }

        profileForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Validate form
            const fieldRules = {
                'github': [validators.url],
                'linkedin': [validators.url],
                'bio': [validators.minLength(10)]
            };

            if (!validateForm(profileForm, fieldRules)) {
                showFormError('Please fix the errors above before saving.');
                return;
            }

            // Show loading state
            showLoading(saveButton, 'Save Profile');

            try {
                // Get current user
                const user = await window.authHelpers.getCurrentUser();
                if (!user) {
                    hideLoading(saveButton);
                    showFormError('You must be logged in to save your profile.');
                    return;
                }

                // Upload avatar to Storage if a new file was selected
                let avatarUrl = profileImageData; // Keep existing URL if no new file
                if (avatarFile) {
                    try {
                        avatarUrl = await uploadAvatarToStorage(avatarFile, user.id);
                        profileImageData = avatarUrl; // Update for future reference
                        avatarFile = null; // Clear file reference
                    } catch (error) {
                        hideLoading(saveButton);
                        const friendlyError = getUserFriendlyError(error);
                        showFormError(`Failed to upload avatar: ${friendlyError}`);
                        return;
                    }
                }

                // Prepare profile data
                const skillsArray = document.getElementById('skills').value
                    .split(',')
                    .map(s => s.trim())
                    .filter(s => s.length > 0);

                const interestsArray = document.getElementById('interests').value
                    .split(',')
                    .map(i => i.trim())
                    .filter(i => i.length > 0);

                const profileData = {
                    full_name: document.getElementById('full-name').value,
                    college: document.getElementById('college').value,
                    bio: document.getElementById('bio').value,
                    skills: skillsArray,
                    interests: interestsArray,
                    github_url: document.getElementById('github').value || null,
                    linkedin_url: document.getElementById('linkedin').value || null,
                    availability: document.getElementById('availability').value || null,
                    avatar_url: avatarUrl || null
                };

                // Save to database
                const { data, error } = await window.supabase
                    .from('profiles')
                    .upsert({
                        id: user.id,
                        ...profileData,
                        updated_at: new Date().toISOString()
                    }, {
                        onConflict: 'id'
                    });

                if (error) {
                    throw error;
                }

                // Clear localStorage (we're using database now)
                localStorage.removeItem('userProfile');

                // Update match scores in background (skills may have changed)
                if (user && window.projects && window.projects.updateUserMatchScores) {
                    window.projects.updateUserMatchScores(user.id).catch(err => {
                        console.warn('Error updating match scores after profile update:', err);
                    });
                }

                // Show success message
                window.toast.success('Profile updated successfully! Redirecting...');

                // Redirect after profile completion
                setTimeout(() => {
                    if (onboardingMode) {
                        window.location.href = 'explore.html';
                    } else {
                        window.location.href = 'index.html';
                    }
                }, 1500);
            } catch (error) {
                hideLoading(saveButton);
                console.error('Profile save error:', error);
                const friendlyError = getUserFriendlyError(error);
                showFormError(friendlyError);
            }
        });
    </script>
</body>

</html>