<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kollabx - Notifications</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/sections.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <nav class="navbar">
        <h1 style="color: var(--primary-color);">Kollabx</h1>
        <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="mobile-overlay"></div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Home</a></li>
            <li><a href="explore.html" class="nav-item">Explore</a></li>
            <li><a href="post.html" class="nav-item">Post</a></li>
            <li><a href="dashboard.html" class="nav-item">Dashboard</a></li>
            <li><a href="profile.html" class="nav-item">Profile</a></li>
            <div class="nav-indicator"></div>
        </ul>
        <div class="nav-right">
            <a href="notifications.html" class="notification-icon" aria-label="Notifications">
                <i data-lucide="bell" aria-hidden="true"></i>
                <div class="notification-badge" aria-hidden="true" style="display: none;">0</div>
            </a>
            <a href="signin.html" class="btn-signin">Sign In</a>
        </div>
    </nav>

    <main style="padding-top: 120px;">
        <section class="why-section" style="padding: 2rem 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 class="fade-in-up">Your Notifications</h2>
                <button id="mark-all-read-btn" class="btn-mark-all-read" style="display: none; padding: 0.6rem 1.2rem; background: var(--primary-color); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 0.9rem;">Mark All as Read</button>
            </div>
            
            <!-- Loading State -->
            <div id="notifications-loading" class="notifications-loading">
                <div class="loading-spinner"></div>
                <p>Loading notifications...</p>
            </div>

            <!-- Empty State -->
            <div id="notifications-empty" class="notifications-empty hidden">
                <div class="empty-emoji">ðŸ””</div>
                <h2>No notifications yet</h2>
                <p>You'll see notifications here when someone applies to your projects or when your applications are reviewed.</p>
            </div>

            <!-- Notifications Container -->
            <div id="notifications-container" class="kx-feature-container hidden">
                <!-- Notifications will be dynamically inserted here -->
            </div>
        </section>
    </main>
    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-brand">
                <div class="logo">
                    <i data-lucide="rocket"></i>
                    <span>KollabX</span>
                </div>
                <p>Connecting builders, one idea at a time. Find teammates by skills, not spam.</p>
                <div class="footer-badges">
                    <span class="f-badge">Student-first</span>
                    <span class="f-badge">Skill matching</span>
                    <span class="f-badge">Private chat</span>
                </div>
            </div>

            <div class="footer-col">
                <h4>Product</h4>
                <ul>
                    <li><a href="explore.html">Features</a></li>
                    <li><a href="index.html#how-it-works">How it works</a></li>
                    <li><a href="index.html#faq">FAQ</a></li>
                    <li><a href="explore.html">Explore ideas</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>Community</h4>
                <ul>
                    <li><a href="mailto:community@kollabx.com">Campus ambassadors</a></li>
                    <li><a href="mailto:partners@kollabx.com">Hackathon partners</a></li>
                    <li><a href="mailto:clubs@kollabx.com">Clubs & societies</a></li>
                    <li><a href="mailto:feedback@kollabx.com">Feedback</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>Support</h4>
                <ul>
                    <li><a href="mailto:privacy@kollabx.com">Privacy & safety</a></li>
                    <li><a href="mailto:legal@kollabx.com">Terms</a></li>
                    <li><a href="mailto:support@kollabx.com">Report an issue</a></li>
                    <li><a href="mailto:contact@kollabx.com">Contact</a></li>
                </ul>
            </div>

            <div class="footer-newsletter">
                <h4>Get updates</h4>
                <p>New features, campus launches, and hackathon-ready updates.</p>
                <form class="subscribe-form">
                    <input type="email" placeholder="you@college.edu" required>
                    <button type="submit" class="btn-subscribe">Subscribe</button>
                </form>
                <div class="footer-socials">
                    <a href="#" class="social-btn"><i data-lucide="mail"></i></a>
                    <a href="#" class="social-btn"><i data-lucide="link"></i></a>
                    <a href="#" class="social-btn"><i data-lucide="instagram"></i></a>
                    <a href="#" class="social-btn"><i data-lucide="github"></i></a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>Â© 2026 KollabX â€¢ Made with ðŸ”¥ for problem solvers</p>
            <div class="status-indicator">
                <div class="dot"></div>
                <span>Status: Beta</span>
            </div>
        </div>
    </footer>
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/explore.css">
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/session.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/form-validation.js"></script>
    <script src="js/main.js"></script>
    <script src="js/sections.js"></script>
    <script>
        // Initialize auth and protect route
        window.addEventListener('DOMContentLoaded', async () => {
            const isAuth = await window.session.requireAuth();
            if (isAuth) {
                await window.session.initAuth();
                await loadNotifications();
            }
            lucide.createIcons();
        });

        // Format relative time
        function formatRelativeTime(date) {
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            if (diffDays < 30) return `${Math.floor(diffDays / 7)} week${Math.floor(diffDays / 7) > 1 ? 's' : ''} ago`;
            if (diffDays < 365) return `${Math.floor(diffDays / 30)} month${Math.floor(diffDays / 30) > 1 ? 's' : ''} ago`;
            return `${Math.floor(diffDays / 365)} year${Math.floor(diffDays / 365) > 1 ? 's' : ''} ago`;
        }

        // Get icon for notification type
        function getNotificationIcon(type) {
            const icons = {
                'application_received': 'user-plus',
                'application_accepted': 'check-circle',
                'application_rejected': 'x-circle',
                'team_member_added': 'users',
                'project_update': 'message-square',
                'project_created': 'rocket'
            };
            return icons[type] || 'bell';
        }

        // Get color theme for notification type
        function getNotificationTheme(type) {
            const themes = {
                'application_received': 'peach',
                'application_accepted': 'mint',
                'application_rejected': 'blue',
                'team_member_added': 'purple',
                'project_update': 'purple',
                'project_created': 'mint'
            };
            return themes[type] || 'blue';
        }

        // Escape HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Load notifications
        async function loadNotifications() {
            const loadingDiv = document.getElementById('notifications-loading');
            const emptyDiv = document.getElementById('notifications-empty');
            const container = document.getElementById('notifications-container');

            loadingDiv.classList.remove('hidden');
            emptyDiv.classList.add('hidden');
            container.classList.add('hidden');

            try {
                const result = await window.notifications.getAllNotifications();

                if (!result.success || !result.data || result.data.length === 0) {
                    loadingDiv.classList.add('hidden');
                    emptyDiv.classList.remove('hidden');
                    container.classList.add('hidden');
                    document.getElementById('mark-all-read-btn').style.display = 'none';
                    return;
                }

                loadingDiv.classList.add('hidden');
                emptyDiv.classList.add('hidden');
                container.classList.remove('hidden');

                // Show mark all as read button if there are unread notifications
                const hasUnread = result.data.some(n => !n.read);
                document.getElementById('mark-all-read-btn').style.display = hasUnread ? 'block' : 'none';

                // Render notifications
                container.innerHTML = result.data.map(notification => {
                    const theme = getNotificationTheme(notification.type);
                    const icon = getNotificationIcon(notification.type);
                    const timeAgo = formatRelativeTime(new Date(notification.created_at));
                    const isUnread = !notification.read;

                    return `
                        <div class="kx-feature-card kx-feature--${theme} kx-feature--small-icon fade-in-up notification-item ${isUnread ? 'notification-unread' : ''}" data-notification-id="${notification.id}">
                            <div class="kx-illustration-area">
                                <div class="kx-illustration-bg"></div>
                                <i data-lucide="${icon}" style="position: relative; z-index: 3;"></i>
                            </div>
                            <div class="kx-content-area">
                                <h3 class="kx-feature-title">${escapeHtml(notification.title)}</h3>
                                <p class="kx-feature-desc">${escapeHtml(notification.message)}</p>
                                <span class="kx-feature-meta">${timeAgo}</span>
                            </div>
                            <div class="kx-feature-action" aria-label="View notification">
                                ${notification.link ? `<a href="${notification.link}" style="text-decoration: none; color: inherit;">` : ''}
                                <i data-lucide="chevron-right" aria-hidden="true"></i>
                                ${notification.link ? '</a>' : ''}
                            </div>
                            ${isUnread ? '<div class="notification-dot"></div>' : ''}
                            <div class="kx-ambient-dot" style="width: 6px; height: 6px; top: 15%; left: 10%;"></div>
                        </div>
                    `;
                }).join('');

                // Initialize icons
                if (window.lucide) {
                    lucide.createIcons();
                }

                // Add click handlers to mark as read
                container.querySelectorAll('.notification-item').forEach(item => {
                    item.addEventListener('click', async () => {
                        const notificationId = item.dataset.notificationId;
                        if (!item.classList.contains('notification-read')) {
                            await window.notifications.markNotificationAsRead(notificationId);
                            item.classList.remove('notification-unread');
                            item.querySelector('.notification-dot')?.remove();
                            
                            // Hide mark all button if no unread left
                            const hasUnread = container.querySelector('.notification-unread');
                            if (!hasUnread) {
                                document.getElementById('mark-all-read-btn').style.display = 'none';
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading notifications:', error);
                loadingDiv.classList.add('hidden');
                emptyDiv.classList.remove('hidden');
                container.classList.add('hidden');
            }
        }

        // Mark all as read
        document.getElementById('mark-all-read-btn')?.addEventListener('click', async () => {
            const result = await window.notifications.markAllNotificationsAsRead();
            if (result.success) {
                await loadNotifications();
            }
        });
    </script>
</body>

</html>