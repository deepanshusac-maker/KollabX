<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kollabx - Dashboard</title>
    <link rel="stylesheet" href="css/global.css">
    <link rel="stylesheet" href="css/components.css">
    <link rel="stylesheet" href="css/dashboard.css">
    <link rel="stylesheet" href="css/sections.css">
    <link rel="stylesheet" href="css/auth.css">
    <link rel="stylesheet" href="css/toast.css">
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body>
    <nav class="navbar">
        <h1>Kollabx</h1>
        <button class="mobile-menu-toggle" aria-label="Toggle mobile menu" aria-expanded="false">
            <span></span>
            <span></span>
            <span></span>
        </button>
        <div class="mobile-overlay"></div>
        <ul class="nav-links">
            <li><a href="index.html" class="nav-item">Home</a></li>
            <li><a href="explore.html" class="nav-item">Explore</a></li>
            <li class="nav-item-auth-only" style="display: none;"><a href="post.html" class="nav-item">Post</a></li>
            <li class="nav-item-auth-only" style="display: none;"><a href="dashboard.html" class="nav-item active">Dashboard</a></li>
            <li class="nav-item-auth-only" style="display: none;"><a href="profile.html" class="nav-item">Profile</a></li>
            <div class="nav-indicator"></div>
        </ul>
        <div class="nav-right">
            <button type="button" class="notification-icon" aria-label="Notifications">
                <i data-lucide="bell" aria-hidden="true"></i>
                <div class="notification-badge" aria-hidden="true" style="display: none;">0</div>
            </button>
            <a href="signin.html" class="btn-signin">Sign In</a>
        </div>
    </nav>

    <main class="dashboard-container">
        <!-- Breadcrumbs -->
        <nav class="breadcrumbs" aria-label="Breadcrumb">
            <a href="index.html">Home</a>
            <span aria-hidden="true">/</span>
            <span aria-current="page">Dashboard</span>
        </nav>
        <!-- Hero Section -->
        <header class="dashboard-hero">
            <div class="hero-text">
                <h1>Welcome back ðŸ‘‹</h1>
                <p>Manage your requests, teams, and recommended projects.</p>
            </div>
            <a href="post.html" class="btn-post-idea">
                <i data-lucide="plus"></i>
                Post New Idea
            </a>
        </header>

        <!-- Tabs -->
        <div class="dashboard-tabs">
            <button class="tab-item active" data-tab="all">All</button>
            <button class="tab-item" data-tab="recommended">Recommended</button>
            <button class="tab-item" data-tab="requests">Requests</button>
            <button class="tab-item" data-tab="teams">Teams</button>
        </div>

        <!-- Stats Grid -->
        <div class="stats-grid">
            <div class="glass-card stat-card">
                <span class="stat-value">â€”</span>
                <span class="stat-label">Active Teams</span>
            </div>
            <div class="glass-card stat-card">
                <span class="stat-value">0</span>
                <span class="stat-label">Incoming Requests</span>
            </div>
            <div class="glass-card stat-card">
                <span class="stat-value">0</span>
                <span class="stat-label">My Applications</span>
            </div>
        </div>

        <!-- Content Grid -->
        <div class="content-grid">
            <!-- Recommended for You -->
            <div class="horizontal-card" data-category="recommended">
                <div class="card-icon">
                    <i data-lucide="shield"></i>
                </div>
                <div class="card-content">
                    <h2>Recommended for You</h2>
                    <p>Discover projects tailored to your specific skill set and interests.</p>
                    <div id="recommended-projects-container" class="recommended-projects-container">
                        <div class="empty-state">
                            <span class="sub-text">Calculating recommendations...</span>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="btn-arrow" aria-label="View details" id="toggle-recommended-projects">
                        <i data-lucide="arrow-right" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <!-- Incoming Requests -->
            <div class="horizontal-card" data-category="requests">
                <div class="card-icon">
                    <i data-lucide="filter"></i>
                </div>
                <div class="card-content">
                    <h2>Incoming Requests</h2>
                    <p>Manage project join requests from other talented builders.</p>
                    <div id="incoming-applications-container" class="applications-container">
                        <div class="empty-state">
                            <span class="sub-text">No one has requested to join your projects yet.</span>
                            <a href="post.html" class="btn-post-project" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Post a Project</a>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="btn-arrow" aria-label="View details" id="toggle-incoming-applications">
                        <i data-lucide="arrow-right" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <!-- My Requests -->
            <div class="horizontal-card" data-category="requests">
                <div class="card-icon">
                    <i data-lucide="layout"></i>
                </div>
                <div class="card-content">
                    <h2>My Applications</h2>
                    <p>Track the status of your applications to join exciting new projects.</p>
                    <div id="my-applications-container" class="applications-container">
                        <div class="empty-state">
                            <span class="sub-text">You haven't applied to any projects yet.</span>
                            <a href="explore.html" class="btn-explore-projects" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Explore Projects</a>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="btn-arrow" aria-label="View details" id="toggle-my-applications">
                        <i data-lucide="arrow-right" aria-hidden="true"></i>
                    </button>
                </div>
            </div>

            <!-- My Teams -->
            <div class="horizontal-card" data-category="teams">
                <div class="card-icon">
                    <i data-lucide="rocket"></i>
                </div>
                <div class="card-content">
                    <h2>My Teams</h2>
                    <p>Collaborate and build with your roster of teammates across all projects.</p>
                    <div id="my-teams-container" class="teams-container">
                        <div class="empty-state">
                            <span class="sub-text">You're not in any teams yet. Explore and apply.</span>
                            <a href="explore.html" class="btn-explore-projects" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Explore Projects</a>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <button class="btn-arrow" aria-label="View details" id="toggle-my-teams">
                        <i data-lucide="arrow-right" aria-hidden="true"></i>
                    </button>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="main-footer">
        <div class="footer-container">
            <div class="footer-brand">
                <div class="logo">
                    <i data-lucide="rocket"></i>
                    <span>KollabX</span>
                </div>
                <p>Connecting builders, one idea at a time. Find teammates by skills, not spam.</p>
                <div class="footer-badges">
                    <span class="f-badge">Student-first</span>
                    <span class="f-badge">Skill matching</span>
                    <span class="f-badge">Private chat</span>
                </div>
            </div>

            <div class="footer-col">
                <h4>Product</h4>
                <ul>
                    <li><a href="explore.html">Features</a></li>
                    <li><a href="index.html#how-it-works">How it works</a></li>
                    <li><a href="index.html#faq">FAQ</a></li>
                    <li><a href="explore.html">Explore ideas</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>Community</h4>
                <ul>
                    <li><a href="mailto:community@kollabx.com">Campus ambassadors</a></li>
                    <li><a href="mailto:partners@kollabx.com">Hackathon partners</a></li>
                    <li><a href="mailto:clubs@kollabx.com">Clubs & societies</a></li>
                    <li><a href="mailto:feedback@kollabx.com">Feedback</a></li>
                </ul>
            </div>

            <div class="footer-col">
                <h4>Support</h4>
                <ul>
                    <li><a href="mailto:privacy@kollabx.com">Privacy & safety</a></li>
                    <li><a href="mailto:legal@kollabx.com">Terms</a></li>
                    <li><a href="mailto:support@kollabx.com">Report an issue</a></li>
                    <li><a href="mailto:contact@kollabx.com">Contact</a></li>
                </ul>
            </div>

            <div class="footer-newsletter">
                <h4>Get updates</h4>
                <p>New features, campus launches, and hackathon-ready updates.</p>
                <form class="subscribe-form">
                    <input type="email" placeholder="you@college.edu" required>
                    <button type="submit" class="btn-subscribe">Subscribe</button>
                </form>
                <div class="footer-socials">
                    <a href="#" class="social-btn"><i data-lucide="mail"></i></a>
                    <a href="#" class="social-btn"><i data-lucide="link"></i></a>
                    <a href="#" class="social-btn"><i data-lucide="instagram"></i></a>
                    <a href="#" class="social-btn"><i data-lucide="github"></i></a>
                </div>
            </div>
        </div>

        <div class="footer-bottom">
            <p>Â© 2026 KollabX â€¢ Made with ðŸ”¥ for problem solvers</p>
            <div class="status-indicator">
                <div class="dot"></div>
                <span>Status: Beta</span>
            </div>
        </div>
    </footer>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/session.js"></script>
    <script src="js/notifications.js"></script>
    <script src="js/projects.js"></script>
    <script src="js/applications.js"></script>
    <script src="js/teams.js"></script>
    <script src="js/form-validation.js"></script>
    <script src="js/toast.js"></script>
    <script src="js/main.js"></script>
    <script src="js/dashboard.js"></script>
    <script>
        // Initialize auth and protect route
        window.addEventListener('DOMContentLoaded', async () => {
            // Check authentication
            const isAuth = await window.session.requireAuth();
            if (isAuth) {
                await window.session.initAuth();
                await loadDashboardData();
                
                // Add toggle handlers for expandable sections
                setupToggleHandlers();
            }
            // Initialize Lucide Icons
            lucide.createIcons();
        });

        // Setup toggle handlers for expandable sections
        function setupToggleHandlers() {
            // Toggle recommended projects
            const toggleRecommended = document.getElementById('toggle-recommended-projects');
            if (toggleRecommended) {
                toggleRecommended.addEventListener('click', () => {
                    const container = document.getElementById('recommended-projects-container');
                    if (container) {
                        container.style.display = container.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            // Toggle incoming applications
            const toggleIncoming = document.getElementById('toggle-incoming-applications');
            if (toggleIncoming) {
                toggleIncoming.addEventListener('click', () => {
                    const container = document.getElementById('incoming-applications-container');
                    if (container) {
                        container.style.display = container.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            // Toggle my applications
            const toggleMyApps = document.getElementById('toggle-my-applications');
            if (toggleMyApps) {
                toggleMyApps.addEventListener('click', () => {
                    const container = document.getElementById('my-applications-container');
                    if (container) {
                        container.style.display = container.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }

            // Toggle my teams
            const toggleMyTeams = document.getElementById('toggle-my-teams');
            if (toggleMyTeams) {
                toggleMyTeams.addEventListener('click', () => {
                    const container = document.getElementById('my-teams-container');
                    if (container) {
                        container.style.display = container.style.display === 'none' ? 'block' : 'none';
                    }
                });
            }
        }

        // Load dashboard data
        async function loadDashboardData() {
            try {
                // Show loading state
                const statValues = document.querySelectorAll('.stat-value');
                statValues.forEach(stat => {
                    stat.textContent = '...';
                    stat.style.opacity = '0.5';
                });

                const user = await window.authHelpers.getCurrentUser();
                if (!user) {
                    statValues.forEach(stat => {
                        stat.textContent = 'â€”';
                        stat.style.opacity = '1';
                    });
                    return;
                }

                // Load user's projects
                const projectsResult = await window.projects.getUserProjects(user.id);
                const userProjects = projectsResult.data || [];

                // Count active teams (projects user is part of)
                const { data: teamMembers } = await window.supabase
                    .from('team_members')
                    .select('project_id')
                    .eq('user_id', user.id);

                const activeTeamsCount = teamMembers ? teamMembers.length : 0;

                // Count incoming requests (applications to user's projects)
                const projectIds = userProjects.map(p => p.id);
                let incomingRequestsCount = 0;
                if (projectIds.length > 0) {
                    const { count } = await window.supabase
                        .from('applications')
                        .select('*', { count: 'exact', head: true })
                        .in('project_id', projectIds)
                        .eq('status', 'pending');
                    incomingRequestsCount = count || 0;
                }

                // Count user's applications
                const { count: myApplicationsCount } = await window.supabase
                    .from('applications')
                    .select('*', { count: 'exact', head: true })
                    .eq('applicant_id', user.id);

                // Update stats display
                if (statValues.length >= 3) {
                    statValues[0].textContent = activeTeamsCount;
                    statValues[1].textContent = incomingRequestsCount;
                    statValues[2].textContent = myApplicationsCount || 0;
                    statValues.forEach(stat => {
                        stat.style.opacity = '1';
                    });
                }

                // Load applications
                await loadIncomingApplications();
                await loadMyApplications();
                
                // Load teams
                await loadMyTeams();
                
                // Load recommendations
                await loadRecommendedProjects();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                const statValues = document.querySelectorAll('.stat-value');
                statValues.forEach(stat => {
                    stat.textContent = 'â€”';
                    stat.style.opacity = '1';
                });
            }
        }

        // Load my teams
        async function loadMyTeams() {
            const container = document.getElementById('my-teams-container');
            if (!container) return;

            try {
                const result = await window.teams.getUserTeams();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">You're not in any teams yet. Explore and apply.</span>
                            <a href="explore.html" class="btn-explore-projects" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Explore Projects</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = result.data.map(team => {
                    const project = team.project;
                    const isCreator = project?.creator_id === team.user_id;
                    const role = team.role || (isCreator ? 'Creator' : 'Member');
                    
                    return `
                        <div class="team-card-item" data-project-id="${project?.id}">
                            <div class="team-card-header">
                                <div>
                                    <div class="team-project-title">${escapeHtml(project?.title || 'Unknown Project')}</div>
                                    <div class="team-project-meta">
                                        ${project?.category || ''} â€¢ ${project?.current_members || 0}/${project?.team_size || 0} members
                                        ${isCreator ? '<span class="role-badge creator">Creator</span>' : `<span class="role-badge member">${role}</span>`}
                                    </div>
                                </div>
                                <span class="team-status-badge ${project?.status === 'open' ? 'status-open' : ''}">${project?.status || 'Unknown'}</span>
                            </div>
                            ${project?.description ? `<div class="team-project-desc">${escapeHtml(project.description.length > 100 ? project.description.substring(0, 100) + '...' : project.description)}</div>` : ''}
                            <div class="team-card-actions">
                                <a href="explore.html#project-${project?.id}" class="btn-view-team-project">View Project</a>
                                ${!isCreator ? `
                                    <button class="btn-leave-team-card" data-project-id="${project?.id}">Leave Team</button>
                                ` : ''}
                            </div>
                        </div>
                    `;
                }).join('');

                // Add leave team handlers
                container.querySelectorAll('.btn-leave-team-card').forEach(btn => {
                    btn.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const projectId = btn.dataset.projectId;
                        if (confirm('Are you sure you want to leave this team?')) {
                            const result = await window.teams.leaveTeam(projectId);
                            if (result.success) {
                                window.toast.success('You have left the team.');
                                await loadDashboardData(); // Reload dashboard
                            } else {
                                const friendlyError = getUserFriendlyError(result.error || new Error('Failed to leave team'));
                                showFormError(friendlyError);
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading my teams:', error);
            }
        }

        // Load incoming applications
        async function loadIncomingApplications() {
            const container = document.getElementById('incoming-applications-container');
            if (!container) return;

            try {
                const result = await window.applications.getIncomingApplications();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">No one has requested to join your projects yet.</span>
                            <a href="post.html" class="btn-post-project" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Post a Project</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = result.data.map(app => {
                    const applicant = app.applicant;
                    const project = app.project;
                    const applicantName = applicant?.full_name || 'Unknown';
                    const applicantAvatar = applicant?.avatar_url || null;
                    const avatarDisplay = applicantAvatar 
                        ? `<img src="${applicantAvatar}" alt="${applicantName}" class="applicant-avatar">`
                        : `<div class="applicant-avatar-placeholder">${applicantName.charAt(0).toUpperCase()}</div>`;
                    
                    return `
                        <div class="application-item" data-application-id="${app.id}">
                            <div class="application-header">
                                <div class="applicant-info">
                                    ${avatarDisplay}
                                    <div>
                                        <div class="applicant-name">${escapeHtml(applicantName)}</div>
                                        <div class="application-project">Applied to: ${escapeHtml(project?.title || 'Unknown Project')}</div>
                                    </div>
                                </div>
                                <div class="application-status status-pending">Pending</div>
                            </div>
                            ${app.message ? `<div class="application-message">${escapeHtml(app.message)}</div>` : ''}
                            <div class="application-actions">
                                <button class="btn-accept" data-application-id="${app.id}">Accept</button>
                                <button class="btn-reject" data-application-id="${app.id}">Reject</button>
                                <a href="portfolio.html?user=${app.applicant_id}" class="btn-view-profile">View Profile</a>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add event listeners
                container.querySelectorAll('.btn-accept').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await handleAcceptApplication(btn.dataset.applicationId);
                    });
                });

                container.querySelectorAll('.btn-reject').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        await handleRejectApplication(btn.dataset.applicationId);
                    });
                });
            } catch (error) {
                console.error('Error loading incoming applications:', error);
            }
        }

        // Load my applications
        async function loadMyApplications() {
            const container = document.getElementById('my-applications-container');
            if (!container) return;

            try {
                const result = await window.applications.getUserApplications();
                
                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">You haven't applied to any projects yet.</span>
                            <a href="explore.html" class="btn-explore-projects" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Explore Projects</a>
                        </div>
                    `;
                    return;
                }

                container.innerHTML = result.data.map(app => {
                    const project = app.project;
                    const statusClass = app.status === 'accepted' ? 'status-accepted' : 
                                      app.status === 'rejected' ? 'status-rejected' : 'status-pending';
                    const statusText = app.status.charAt(0).toUpperCase() + app.status.slice(1);
                    
                    return `
                        <div class="application-item" data-application-id="${app.id}">
                            <div class="application-header">
                                <div class="applicant-info">
                                    <div>
                                        <div class="applicant-name">${escapeHtml(project?.title || 'Unknown Project')}</div>
                                        <div class="application-project">${project?.category || ''} â€¢ ${project?.current_members || 0}/${project?.team_size || 0} members</div>
                                    </div>
                                </div>
                                <div class="application-status ${statusClass}">${statusText}</div>
                            </div>
                            ${app.message ? `<div class="application-message">${escapeHtml(app.message)}</div>` : ''}
                            <div class="application-actions">
                                ${app.status === 'pending' ? `<button class="btn-cancel-application" data-application-id="${app.id}">Cancel</button>` : ''}
                                <a href="explore.html" class="btn-view-project">View Project</a>
                            </div>
                        </div>
                    `;
                }).join('');

                // Add cancel event listeners
                container.querySelectorAll('.btn-cancel-application').forEach(btn => {
                    btn.addEventListener('click', async () => {
                        if (confirm('Are you sure you want to cancel this application?')) {
                            await handleCancelApplication(btn.dataset.applicationId);
                        }
                    });
                });
            } catch (error) {
                console.error('Error loading my applications:', error);
            }
        }

        // Handle accept application
        async function handleAcceptApplication(applicationId) {
            try {
                const result = await window.applications.acceptApplication(applicationId);
                
                if (result.success) {
                    window.toast.success('Application accepted! Team member joined successfully.');
                    await loadDashboardData(); // Reload to update stats and lists
                } else {
                    const friendlyError = getUserFriendlyError(result.error || new Error('Failed to accept application'));
                    showFormError(friendlyError);
                }
            } catch (error) {
                const friendlyError = getUserFriendlyError(error);
                showFormError(friendlyError);
            }
        }

        // Handle reject application
        async function handleRejectApplication(applicationId) {
            if (!confirm('Are you sure you want to reject this application?')) {
                return;
            }

            try {
                const result = await window.applications.rejectApplication(applicationId);
                
                if (result.success) {
                    window.toast.success('Application rejected.');
                    await loadDashboardData(); // Reload to update stats and lists
                } else {
                    const friendlyError = getUserFriendlyError(result.error || new Error('Failed to reject application'));
                    showFormError(friendlyError);
                }
            } catch (error) {
                const friendlyError = getUserFriendlyError(error);
                showFormError(friendlyError);
            }
        }

        // Handle cancel application
        async function handleCancelApplication(applicationId) {
            try {
                const result = await window.applications.cancelApplication(applicationId);
                
                if (result.success) {
                    window.toast.success('Application cancelled.');
                    await loadDashboardData(); // Reload to update stats and lists
                } else {
                    const friendlyError = getUserFriendlyError(result.error || new Error('Failed to cancel application'));
                    showFormError(friendlyError);
                }
            } catch (error) {
                const friendlyError = getUserFriendlyError(error);
                showFormError(friendlyError);
            }
        }

        // Load recommended projects
        async function loadRecommendedProjects() {
            const container = document.getElementById('recommended-projects-container');
            if (!container) return;

            try {
                const user = await window.authHelpers.getCurrentUser();
                if (!user) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">Sign in to see personalized recommendations.</span>
                            <a href="signin.html" class="btn-signin" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Sign In</a>
                        </div>
                    `;
                    return;
                }

                // Check if user has skills in profile
                const { data: profile } = await window.supabase
                    .from('profiles')
                    .select('skills')
                    .eq('id', user.id)
                    .single();

                if (!profile || !profile.skills || profile.skills.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">No recommendations yet. Update your profile skills to get personalized matches.</span>
                            <a href="profile.html" class="btn-update-profile" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Update Profile</a>
                        </div>
                    `;
                    return;
                }

                // Update match scores periodically (every 5 minutes or on first load)
                const lastUpdateKey = `match_scores_updated_${user.id}`;
                const lastUpdate = localStorage.getItem(lastUpdateKey);
                const now = Date.now();
                const fiveMinutes = 5 * 60 * 1000;

                // Check if we need to update (first time or > 5 minutes)
                if (!lastUpdate || (now - parseInt(lastUpdate)) > fiveMinutes) {
                    // Show loading state
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">Calculating your personalized recommendations...</span>
                        </div>
                    `;

                    // Update match scores (await to ensure it completes before loading)
                    try {
                        const updateResult = await window.projects.updateUserMatchScores(user.id);
                        if (updateResult.success) {
                            localStorage.setItem(lastUpdateKey, now.toString());
                            console.log(`Updated ${updateResult.data?.updated || 0} match scores`);
                        }
                    } catch (err) {
                        console.warn('Error updating match scores:', err);
                        // Continue anyway to show existing recommendations
                    }
                }

                // Get recommended projects
                const result = await window.projects.getRecommendedProjects(user.id, 6);

                if (!result.success || !result.data || result.data.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <span class="sub-text">No recommendations found. Try updating your skills or explore all projects.</span>
                            <a href="explore.html" class="btn-explore-projects" style="margin-top: 1rem; display: inline-block; padding: 0.6rem 1.5rem; background: var(--primary-color); color: white; border-radius: 12px; text-decoration: none; font-weight: 600; font-size: 0.9rem;">Explore Projects</a>
                        </div>
                    `;
                    return;
                }

                // Render recommended projects
                container.innerHTML = result.data.map(project => {
                    const creatorName = project.creator?.full_name || 'Unknown';
                    const matchScore = project.match_score || 0;
                    const description = (project.description || '').length > 100
                        ? project.description.substring(0, 100) + '...'
                        : (project.description || '');

                    return `
                        <div class="recommended-project-item" data-project-id="${project.id}">
                            <div class="recommended-project-header">
                                <div>
                                    <div class="recommended-project-title">${escapeHtml(project.title || 'Untitled Project')}</div>
                                    <div class="recommended-project-meta">
                                        ${project.category || ''} â€¢ ${project.current_members || 0}/${project.team_size || 1} members
                                        <span class="match-score-badge">${matchScore}% match</span>
                                    </div>
                                </div>
                            </div>
                            ${description ? `<div class="recommended-project-desc">${escapeHtml(description)}</div>` : ''}
                            ${project.required_skills && project.required_skills.length > 0 ? `
                                <div class="recommended-project-skills">
                                    ${project.required_skills.slice(0, 3).map(skill => 
                                        `<span class="skill-tag-small">${escapeHtml(String(skill))}</span>`
                                    ).join('')}
                                    ${project.required_skills.length > 3 ? `<span class="skill-more">+${project.required_skills.length - 3}</span>` : ''}
                                </div>
                            ` : ''}
                            <div class="recommended-project-actions">
                                <a href="explore.html#project-${project.id}" class="btn-view-recommended">View Project</a>
                            </div>
                        </div>
                    `;
                }).join('');

                // Initialize icons
                if (window.lucide) {
                    lucide.createIcons();
                }
            } catch (error) {
                console.error('Error loading recommended projects:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <span class="sub-text">Error loading recommendations. Please try again later.</span>
                    </div>
                `;
            }
        }

        // Escape HTML helper
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>

</html>